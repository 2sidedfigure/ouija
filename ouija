#!/usr/bin/env node

"use strict";

var

prog = require('commander'),
pkg = require('./package.json');

prog.version(pkg.version)
    .usage('[options]')
    .option('-p, --port <n>', 'The port to bind the proxy server to, defaults to 6660', parseInt)
    .parse(process.argv);

// if the user hasn't requested help or the version, time to get to work

var

http = require('http'),
responseLib = require('./lib/response'),
setCookie = require('./lib/setcookie'),

server = http.createServer(function(req, res) {
    var response = responseLib.create(req.url, {
            returnUnmodifiedContent: !!req.headers['ouija-get-unmodified-content'],
            wait: req.headers['ouija-wait'],
            debug: true
        });

    // use a proxy if specified
    ['proxy', 'proxy-type', 'proxy-auth'].forEach(function(key) {
        var val = req.headers['ouija-' + key];

        val && response.setPhantomParameter(key, val);
    });

    // set custom headers
    for (var h in req.headers) {
        var match = /^ouija\-pass\-(.*)$/i.exec(h);

        if (match && match[1]) {
            response.setCustomHeader(match[1], req.headers[h]);
        }
    }

    response.fetch(function(err, phRes, debug) {
        debug && debug.length && console.log(debug);

        if (err) {
            res.writeHead(err.status);
            res.write(err.message);
            return res.end();
        }

        // set response headers
        if (phRes.headers) {
            for (var h in phRes.headers) {
                res.setHeader(h, phRes.headers[h]);
            }
        }

        // recalculate the Content-Length header
        res.setHeader('Content-Length', (new Buffer(phRes.body)).length);

        // add the Set-Cookie header
        if (phRes.cookies) {
            var setCookieHeader = [];

            for (var c in phRes.cookies) {
                setCookieHeader.push(setCookie.format(phRes.cookies[c]));
            }

            res.setHeader('Set-Cookie', setCookieHeader);
        }

        // send the response
        res.writeHead(phRes.httpStatus || 200);
        res.write(phRes.body);
        return res.end();
    });

}).listen(prog.port || 6660),

address = server.address();

console.log('=> Ouija listening on ' + address.address + ':' + address.port);
